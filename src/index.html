<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>美容師練習管理アプリ V2 (テスト)</title>
  <?!= include('styles'); ?> <!-- スタイルを有効化 -->
</head>
<body>

  <header class="site-header">
    <div class="container site-header__inner">
      <h1>美容師練習管理アプリ V2</h1>
      <div class="user-info"></div>
    </div>
  </header>

  <main class="site-main container">
    <h2>ようこそ！</h2>
    <p>これは共通基盤の動作確認用ページです。</p>

    <div id="message" class="message"></div> <!-- メッセージ表示エリア -->

    <button class="btn btn--primary" onclick="testSuccessMessage()">成功メッセージ表示</button>
    <button class="btn btn--danger" onclick="testErrorMessage()">エラーメッセージ表示</button>
    <button class="btn btn--secondary" onclick="clearMessage('message')">メッセージクリア</button> <!-- clearMessageを呼び出す -->

  </main>

  <footer class="site-footer">
    <p>© 2025 美容師練習管理アプリ V2</p>
  </footer>
  <?!= include('script'); ?> <!-- スクリプトを有効化 -->
  <script>
    let webAppUrl = ''; // WebアプリのURLを保持するグローバル変数

    // DOM読み込み完了後に関数を実行
    domReady(function() {
      console.log("DOM Ready. Checking session...");
      showMessage("セッションを確認中...", "info", "message"); // メッセージ表示エリアを指定

      // ★★★ WebアプリURLを取得 ★★★
      console.log("<<< Calling google.script.run.checkSession NOW >>>");
      
      google.script.run
          .withSuccessHandler(function(url) {
              if (url) {
                  webAppUrl = url;
                  console.log('Web App URL:', webAppUrl);
              } else {
                  console.error('Failed to get Web App URL.');
                  showMessage("ページの初期化に失敗しました(URL取得不可)。", "error", "message");
              }
          })
          .withFailureHandler(handleApiError) // 既存のエラーハンドラを使う
          .getWebAppUrl(); // GASの関数を呼び出す

      // セッションチェックはURL取得と並行して実行しても良いが、
      // ログインボタンが押されるまでURLは必須ではないのでこのままでもOK
      google.script.run
        .withSuccessHandler(handleSessionCheck)
        .withFailureHandler(handleApiError)
        .checkSession();
    });

    // セッションチェック成功時の処理 (変更なし)
    function handleSessionCheck(result) {
      // ... (前回のコードと同じ) ...
    }

    // API呼び出し失敗時の処理 (変更なし)
    function handleApiError(error) {
        console.log(">>> handleApiError CALLED. Error:", error);
      // ... (前回のコードと同じ) ...
    }

    // Googleログイン処理を修正
    function loginWithGoogle() {
        if (!webAppUrl) {
             console.error("Web App URL is not available. Cannot redirect for login.");
             showMessage("ログイン処理を開始できません。ページをリロードしてください。", "error", "message");
             return;
        }
        showMessage("Googleアカウントでログインしています...", "info", "message");
        // リロードではなく、取得したURLに遷移する
        console.log('Redirecting to login URL:', webAppUrl);
        setTimeout(() => { // 少し待機してから遷移
           window.location.href = webAppUrl;
        }, 500); // 500ミリ秒待機
    }

    // ログアウト処理 (変更なし、画面書き換え版のまま)
    function logoutUser() {
       // ... (前回の画面書き換え版コードと同じ) ...
       console.log("Logging out...");
       showMessage("ログアウト処理中...", "info", "message");
       google.script.run
         .withSuccessHandler(handleLogoutSuccess) // 画面書き換え版のハンドラ
         .withFailureHandler(handleApiError)
         .logout();
    }

    // ログアウト成功時の処理 (変更なし、画面書き換え版のまま)
    function handleLogoutSuccess(result) {
        console.log(">>> handleSessionCheck CALLED. Result:", result); 
        // ... (前回の画面書き換え版コードと同じ) ...
         console.log("handleLogoutSuccess called (screen update version). Result:", result);
         if (result && result.success) {
            const userInfoElement = document.querySelector('.user-info');
            const mainContentElement = document.querySelector('.site-main');
            if (userInfoElement) userInfoElement.innerHTML = '';
            if (mainContentElement) {
                mainContentElement.innerHTML = `... (ログインフォームHTML) ...`; // ← ログインフォームのHTMLを記述
                showMessage("ログアウトしました。", "success", "message");
            } else { /* エラー処理 */ }
         } else { /* エラー処理 */ }
    }
  </script>
</body>
</html>