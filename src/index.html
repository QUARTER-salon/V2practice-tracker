<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>美容師練習管理アプリ V2 (テスト)</title>
  <?!= include('styles'); ?> <!-- スタイルを有効化 -->
</head>
<body>

  <header class="site-header">
    <div class="container site-header__inner">
      <h1>美容師練習管理アプリ V2</h1>
      <div class="user-info"></div>
    </div>
  </header>

  <main class="site-main container">
    <h2>ようこそ！</h2>
    <p>これは共通基盤の動作確認用ページです。</p>

    <div id="message" class="message"></div> <!-- メッセージ表示エリア -->

    <button class="btn btn--primary" onclick="testSuccessMessage()">成功メッセージ表示</button>
    <button class="btn btn--danger" onclick="testErrorMessage()">エラーメッセージ表示</button>
    <button class="btn btn--secondary" onclick="clearMessage('message')">メッセージクリア</button> <!-- clearMessageを呼び出す -->

  </main>

  <footer class="site-footer">
    <p>© 2025 美容師練習管理アプリ V2</p>
  </footer>

  <?!= include('script'); ?> <!-- スクリプトを有効化 -->
  <script>
    // DOM読み込み完了後に関数を実行
    domReady(function() {
      console.log("DOM Ready. Checking session...");
      showMessage("セッションを確認中...", "info", "message"); // メッセージ表示エリアを指定

      google.script.run
        .withSuccessHandler(handleSessionCheck)
        .withFailureHandler(handleApiError)
        .checkSession(); // Auth.js の checkSession を呼び出す
    });

    // セッションチェック成功時の処理
    function handleSessionCheck(result) {
      console.log("Session check result:", result);
      clearMessage("message"); // メッセージをクリア
      const userInfoElement = document.querySelector('.user-info');
      const mainContentElement = document.querySelector('.site-main'); // メインコンテンツエリアを取得

      if (!userInfoElement || !mainContentElement) {
          console.error("必要な要素が見つかりません (.user-info or .site-main)");
          showMessage("ページの初期化に失敗しました。", "error", "message");
          return;
      }

      if (result && result.isLoggedIn && result.userInfo) {
        // ログイン済みの場合の処理
        const userInfo = result.userInfo;
        userInfoElement.innerHTML = `
            <span>${userInfo.store} ${userInfo.name} さん ${userInfo.isAdmin ? '(管理者)' : ''}</span>
            <button class="btn btn--secondary btn--small" onclick="logoutUser()">ログアウト</button>
        `;
        // メインコンテンツエリアを書き換え（本来は別ファイルをインクルードなど）
        mainContentElement.innerHTML = `
            <h2>練習記録</h2>
            <div id="message" class="message"></div> <!-- メッセージ表示エリア -->
            <p>ようこそ、${userInfo.name}さん。ここから練習記録を開始します。</p>
            <!-- TODO: 練習記録フォームなどをここに表示 -->
        `;
        // 必要に応じて、管理者メニューへのリンクなどを isAdmin フラグで制御

      } else {
        // 未ログインの場合の処理
        userInfoElement.innerHTML = ''; // ユーザー情報クリア
        // メインコンテンツエリアをログインフォームに書き換え
        mainContentElement.innerHTML = `
             <h2>ログイン</h2>
             <div id="message" class="message"></div> <!-- メッセージ表示エリア -->
             <p>Googleアカウントでログインしてください。</p>
             <button class="btn btn--primary" onclick="loginWithGoogle()">Googleアカウントでログイン</button>
        `;
        // エラーメッセージがあれば表示
        if(result && result.error) {
           showMessage(`ログインエラー: ${result.error}`, 'error', 'message');
        } else {
           showMessage("ログインしてください。", "info", "message");
        }
      }
    }

    // API呼び出し失敗時の処理
    function handleApiError(error) {
      console.error("API Error:", error);
      // エラー発生時もログイン画面を表示させるなど、適切なUIにする
      const userInfoElement = document.querySelector('.user-info');
      const mainContentElement = document.querySelector('.site-main');
       if (userInfoElement) userInfoElement.innerHTML = '';
       if (mainContentElement) {
            mainContentElement.innerHTML = `
              <h2>エラー</h2>
              <div id="message" class="message message--error message--visible">サーバーとの通信に失敗しました。</div>
              <p>時間をおいて再試行するか、管理者に連絡してください。</p>
              <p><small>エラー詳細: ${error.message || '不明なエラー'}</small></p>
              <button class="btn btn--secondary" onclick="window.location.reload()">再読み込み</button>
           `;
       }
      // handleError(error, "サーバーとの通信に失敗しました", "message"); // メッセージエリアに表示
    }

    // Googleログイン処理 (シンプル版: ページリロードを促す)
    function loginWithGoogle() {
        showMessage("Googleアカウントでログインしています...", "info", "message");
        // 認証は doGet アクセス時に行われるため、単純にリロードする
        setTimeout(() => window.location.reload(), 500); // 少し待ってからリロード
    }

    // ログアウト処理
    function logoutUser() {
       console.log("Logging out...");
       showMessage("ログアウト処理中...", "info", "message");
       google.script.run
         .withSuccessHandler(handleLogoutSuccess)
         .withFailureHandler(handleApiError)
         .logout(); // Auth.js の logout を呼び出す
    }

    function handleLogoutSuccess(result) {
        if (result && result.success) {
            showMessage("ログアウトしました。", "success", "message");
            // 画面を未ログイン状態に戻す（リロードが簡単）
            setTimeout(() => window.location.reload(), 1500);
        } else {
            // logout自体が失敗することは考えにくいが念のため
            handleApiError(new Error("ログアウト処理で予期せぬ応答がありました。"));
        }
    }

    // --- 既存のテスト用関数 (不要なら削除) ---
    function testSuccessMessage() { /* ... */ }
    function testErrorMessage() { /* ... */ }
  </script>
</body>
</html>